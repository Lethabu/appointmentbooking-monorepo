name: CI Build & Cloudflare Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install pnpm
        run: npm install -g pnpm@latest
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Monorepo build
        run: pnpm run build

  cloudflare-pages-deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ secrets.CLOUDFLARE_API_TOKEN && secrets.CLOUDFLARE_ACCOUNT_ID }}
    strategy:
      matrix:
        app: [dashboard, booking]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install pnpm
        run: npm install -g pnpm@latest
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm run build
      - name: Deploy ${{ matrix.app }} to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd apps/${{ matrix.app }}
          pnpm install --frozen-lockfile
          pnpm run pages:deploy

  worker-deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ secrets.CLOUDFLARE_API_TOKEN && secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install pnpm
        run: npm install -g pnpm@latest
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Deploy Worker via wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          pnpm --filter @repo/worker deploy || pnpm --filter packages/worker deploy || pnpm run deploy

# Notes:
# - This workflow builds the monorepo on pushes to `main`.
# - Worker (packages/worker) deploys via separate `pnpm run deploy` or CI job using `wrangler deploy`.
# - To enable Cloudflare Pages deployment, set repository secrets:
#   - `CLOUDFLARE_API_TOKEN` (create at https://dash.cloudflare.com/profile/api-tokens with Pages:Edit permission)
#   - `CLOUDFLARE_ACCOUNT_ID` (your Cloudflare account ID from https://dash.cloudflare.com/)
# - Pages projects must be created first: https://dash.cloudflare.com/?to=/:account/pages
# - For Next.js ISR/SSR support, optionally install @cloudflare/next-on-pages and configure wrangler.toml per app.
