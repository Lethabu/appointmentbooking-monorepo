# Production Prometheus Monitoring Configuration
# Comprehensive monitoring for appointment booking system
# Created: 2025-12-31

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'appointmentbooking-prod'
    replica: 'prometheus-1'

# Rule files for alerting
rule_files:
  - "alert_rules.yml"
  - "recording_rules.yml"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Scrape configurations
scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s
    metrics_path: /metrics

  # Node exporter for system metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: node-exporter:9100

  # Web application instances
  - job_name: 'appointmentbooking-web'
    static_configs:
      - targets: 
        - 'web-app-1:3000'
        - 'web-app-2:3000'
        - 'web-app-3:3000'
    scrape_interval: 15s
    metrics_path: /api/metrics
    scrape_timeout: 10s
    honor_labels: true
    params:
      format: ['prometheus']

  # API Gateway
  - job_name: 'api-gateway'
    static_configs:
      - targets: ['api-gateway:8080']
    scrape_interval: 15s
    metrics_path: /metrics

  # Database (PostgreSQL)
  - job_name: 'postgresql'
    static_configs:
      - targets: ['database:5432']
    scrape_interval: 30s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: 'postgres_exporter:9187'

  # Redis
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
    scrape_interval: 30s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: 'redis_exporter:9121'

  # Background worker
  - job_name: 'worker'
    static_configs:
      - targets: ['worker:3001']
    scrape_interval: 30s
    metrics_path: /metrics

  # Nginx load balancer
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-lb:80']
    scrape_interval: 30s
    metrics_path: /nginx_status
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: 'nginx_exporter:9113'

  # Elasticsearch
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch:9200']
    scrape_interval: 30s
    metrics_path: /_prometheus/metrics

  # Custom business metrics
  - job_name: 'business-metrics'
    static_configs:
      - targets:
        - 'web-app-1:3000'
        - 'web-app-2:3000'
        - 'web-app-3:3000'
    scrape_interval: 60s
    metrics_path: /api/business-metrics
    params:
      format: ['prometheus']

  # Security monitoring
  - job_name: 'security-metrics'
    static_configs:
      - targets:
        - 'web-app-1:3000'
        - 'web-app-2:3000'
        - 'web-app-3:3000'
    scrape_interval: 30s
    metrics_path: /api/security-metrics

# Storage configuration
storage:
  tsdb:
    retention.time: 30d
    retention.size: 10GB

# Remote write configuration for long-term storage
remote_write:
  - url: "https://prometheus-remote-storage.appointmentbooking.co.za/api/v1/write"
    queue_config:
      max_samples_per_send: 1000
      max_shards: 200
      capacity: 2500
    write_relabel_configs:
      - source_labels: [__name__]
        regex: 'apiserver_request_duration_seconds_bucket'
        action: drop
      - source_labels: [__name__]
        regex: 'apiserver_request_duration_seconds_count'
        action: drop
      - source_labels: [__name__]
        regex: 'apiserver_request_duration_seconds_sum'
        action: drop

# Remote read configuration
remote_read:
  - url: "https://prometheus-remote-storage.appointmentbooking.co.za/api/v1/read"
    read_recent: true

# Federation configuration
federation:
  scrape_configs:
    - job_name: 'federated'
      static_configs:
        - targets: ['prometheus-remote-storage:9090']
      metrics_path: /federate
      params:
        match[]: '{job=~"appointmentbooking-.*"}'
      honor_labels: true

# Configuration for high availability
high_availability:
  cluster:
    name: "appointmentbooking-prometheus-cluster"
    enabled: true

# Global alerting settings
alerting:
  alert_relabel_configs:
    - source_labels: [alertname]
      regex: '^(HighCPU|HighMemory|HighDisk|ServiceDown).*'
      target_label: severity
      replacement: 'critical'
    - source_labels: [alertname]
      regex: '^(MediumCPU|MediumMemory|MediumDisk).*'
      target_label: severity
      replacement: 'warning'

# Service discovery for dynamic scaling
service_discovery:
  kubernetes_sd_configs:
    - role: pod
      namespaces:
        names:
          - production
          - monitoring

# Custom metrics collection
custom_metrics:
  - name: "appointment_booking_rate"
    query: "rate(appointments_created_total[5m])"
    description: "Rate of new appointment bookings per second"

  - name: "revenue_per_minute"
    query: "rate(revenue_total[5m])"
    description: "Revenue generation rate per minute"

  - name: "active_users"
    query: "active_sessions_total"
    description: "Number of currently active user sessions"

  - name: "api_response_time_p95"
    query: "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
    description: "95th percentile API response time"

  - name: "database_connections_active"
    query: "postgresql_connections_active"
    description: "Active database connections"

  - name: "cache_hit_ratio"
    query: "rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))"
    description: "Redis cache hit ratio"

  - name: "error_rate"
    query: "rate(http_requests_total{status=~'5..'}[5m]) / rate(http_requests_total[5m])"
    description: "Error rate percentage"

  - name: "cpu_utilization"
    query: "100 - (avg(rate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)"
    description: "CPU utilization percentage"

  - name: "memory_utilization"
    query: "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100"
    description: "Memory utilization percentage"

  - name: "disk_utilization"
    query: "100 - ((node_filesystem_avail_bytes{mountpoint='/'} / node_filesystem_size_bytes{mountpoint='/'}) * 100)"
    description: "Disk utilization percentage"

# Alert routing configuration
alert_routing:
  critical:
    - email: "critical-alerts@appointmentbooking.co.za"
    - slack: "alerts-critical"
    - pagerduty: "critical-team"
  
  warning:
    - email: "warning-alerts@appointmentbooking.co.za"
    - slack: "alerts-warning"
  
  info:
    - email: "info-alerts@appointmentbooking.co.za"

# Dashboard integration
dashboard:
  grafana:
    url: "https://grafana.appointmentbooking.co.za"
    org_id: 1
    api_key: "${GRAFANA_API_KEY}"

# Performance tuning
performance:
  max_concurrent_queries: 100
  max_concurrent_scrapes: 10000
  query_timeout: 2m
  query_max_samples: 50000000
  max_points_per_timeseries: 11000